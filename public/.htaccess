<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Set environment variables for IP restriction bypass BEFORE any redirects
    # These use THE_REQUEST which contains the original request line
    # Must use RewriteRule with [E=] flag since SetEnvIf doesn't support THE_REQUEST in .htaccess
    RewriteCond %{THE_REQUEST} \s/webhooks/slack [NC]
    RewriteRule ^ - [E=allow_slack:1]

    # Redirect HTTP to HTTPS for all requests EXCEPT device endpoints
    # Use THE_REQUEST to check original request (not rewritten URI) for dynamic routes
    # Use REQUEST_URI for static file paths (firmware, speedtest)
    # /cwmp - TR-069 device communication
    # /device-upload - TR-069 Upload RPC file reception (devices PUT config files here)
    # /device-config - TR-069 Download RPC file serving (devices GET config files from here)
    # /storage/firmware - Firmware files for TR-069 Download RPC (must be HTTP for some devices)
    # /speedtest - Speed test files for TR-069 Download diagnostic (must be HTTP for some devices)
    RewriteCond %{HTTPS} off
    RewriteCond %{THE_REQUEST} !^[A-Z]+\ /cwmp[\ \?]
    RewriteCond %{THE_REQUEST} !^[A-Z]+\ /device-upload
    RewriteCond %{THE_REQUEST} !^[A-Z]+\ /device-config/
    RewriteCond %{REQUEST_URI} !^/storage/firmware/
    RewriteCond %{REQUEST_URI} !^/speedtest
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Handle X-XSRF-Token Header
    RewriteCond %{HTTP:x-xsrf-token} .
    RewriteRule .* - [E=HTTP_X_XSRF_TOKEN:%{HTTP:X-XSRF-Token}]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Send Requests To Front Controller...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>

# IP Restriction has been MOVED to Apache VirtualHost config
# This allows proper path-based exceptions for:
# - /cwmp (TR-069 device communication)
# - /device-upload, /device-config (TR-069 file transfers)
# - /storage/firmware (firmware downloads)
# - /webhooks/slack (Slack interactive components)
#
# See /etc/httpd/conf.d/hayacs-le-ssl.conf for the IP restrictions
