<IfModule mod_ssl.c>
  <VirtualHost *:443>
      ServerName hayacs.hay.net
      ServerAdmin admin@haymail.ca
      DocumentRoot /var/www/hayacs/public


       # TR-069 CWMP requires longer timeouts for large responses
       # Device needs time to collect all parameters before responding
       Timeout 300
       KeepAlive On
       KeepAliveTimeout 60
       MaxKeepAliveRequests 100

      # ============================================================
      # PATH-BASED ACCESS CONTROL
      # These Location blocks MUST come BEFORE the Directory block
      # to properly override IP restrictions for specific paths
      # ============================================================

      # Slack webhooks - allow from any IP
      # Slack uses dynamic AWS IPs that cannot be whitelisted
      <Location /webhooks/slack>
          Require all granted
      </Location>

      # TR-069 CWMP endpoint - allow from any IP
      # Devices connect from customer premises with various IPs
      <Location /cwmp>
          Require all granted
      </Location>

      # TR-069 file upload endpoint - allow from any IP
      <Location /device-upload>
          Require all granted
      </Location>

      # TR-069 config download endpoint - allow from any IP
      <LocationMatch "^/device-config/">
          Require all granted
      </LocationMatch>

      # Firmware downloads - allow from any IP
      <LocationMatch "^/storage/firmware/">
          Require all granted
      </LocationMatch>

      # Speedtest files - allow from any IP
      <LocationMatch "^/speedtest">
          Require all granted
      </LocationMatch>

      # ============================================================
      # AUTHENTICATION ROUTES - Allow from any IP
      # Field techs need to reach these pages to:
      # 1. Login with credentials
      # 2. Complete 2FA challenge
      # 3. Set trusted device cookie
      # After that, cookie bypasses IP restriction
      # ============================================================

      # Login page and POST
      <Location /login>
          Require all granted
      </Location>

      # Logout endpoint
      <Location /logout>
          Require all granted
      </Location>

      # Two-factor authentication routes
      <LocationMatch "^/two-factor">
          Require all granted
      </LocationMatch>

      # Sanctum CSRF cookie - needed for form submissions
      <Location /sanctum/csrf-cookie>
          Require all granted
      </Location>

      # ============================================================
      # MAIN DIRECTORY - IP RESTRICTED WITH TRUSTED DEVICE BYPASS
      # Users from internal networks OR with trusted device cookie
      # can access all other paths
      # ============================================================
      <Directory /var/www/hayacs/public>
          AllowOverride All
          Options -Indexes +FollowSymLinks

          # Check for trusted device cookie and set environment variable
          # The cookie value doesn't matter here - Laravel validates it
          SetEnvIf Cookie "trusted_device_token=" HAS_TRUSTED_DEVICE

          # IP Restriction - internal networks OR trusted device cookie
          <RequireAny>
              Require ip 163.182.0.0/16
              Require ip 104.247.0.0/16
              Require ip 45.59.0.0/16
              Require ip 136.175.0.0/16
              Require ip 206.130.0.0/16
              Require ip 23.155.0.0/16
              Require env HAS_TRUSTED_DEVICE
          </RequireAny>
      </Directory>

      # Laravel-specific: Deny access to sensitive files
      <Directory /var/www/hayacs/storage>
          Require all denied
      </Directory>

      <Directory /var/www/hayacs/bootstrap/cache>
          Require all denied
      </Directory>

      ErrorLog /var/log/httpd/hayacs-error.log
      CustomLog /var/log/httpd/hayacs-access.log combined

SSLCertificateFile /etc/letsencrypt/live/hayacs.hay.net/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/hayacs.hay.net/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>
